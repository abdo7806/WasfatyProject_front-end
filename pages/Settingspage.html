<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨</title>
    <link rel="stylesheet" href="../css/Settingspage-style.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body>

    <div class="container">
           <button class="back-button" onclick="window.history.back()">
        <i class="fas fa-arrow-left"></i> <!-- Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø³Ù‡Ù… -->
        Ø±Ø¬ÙˆØ¹
    </button>      <h1>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨</h1>
        
        <div class="profile-header">
            <div class="profile-icon">
                <span>ðŸ‘¤</span>
            </div>
            <h2 id="username">Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ Ù…Ø­Ù…Ø¯ Ø£Ø­Ù…Ø¯</h2>
        </div>
        
        <div class="profile-info">
            <h2>Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ©</h2>
            
            <div class="info-item">
                <div class="info-label">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„:</div>
                <div class="info-value" id="fullName">Ù…Ø­Ù…Ø¯ Ø£Ø­Ù…Ø¯</div>
            </div>
            
            <div class="info-item">
                <div class="info-label" >Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</div>
                <div class="info-value" id="email">example@example.com</div>
            </div>
         
           <div class="info-item" >
                <div class="info-label" >Ø§Ù„Ø¯ÙˆØ± :</div>
                <div class="info-value" id="role" >....</div>
            </div >
             <div class="info-item" id="specialization-content" style="display: none;">
                <div class="info-label">Ø§Ù„ØªØ®ØµØµ:</div>
                <div class="info-value" id="specialization">...</div>
            </div>
        </div>
             <div class="info-item" id="licenseNumber-content" style="display: none;">
                <div class="info-label">Ø±Ù‚Ù… Ø§Ù„ØªØ±Ø®ÙŠØµ:</div>
                <div class="info-value" id="licenseNumber">...</div>
            </div>
                   <div class="info-item" id="pharmacy-content" style="display: none;">
                <div class="info-label"> Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ©:</div>
                <div class="info-value" id="pharmacy">...</div>
            </div>
        <div class="password-form">
            <h2>ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</h2>
            <form id="passwordForm">
                <div class="form-group">
                    <label for="currentPassword">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©</label>
                    <input type="password" id="currentPassword" required placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©">
                    <span id="currentPasswordError" class="error"></span>
                </div>
                
                <div class="form-group">
                    <label for="newPassword">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</label>
                    <input type="password" id="newPassword" required placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (8 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)">
                    <span id="newPasswordError" class="error"></span>
                </div>
                
                <div class="form-group">
                    <label for="confirmPassword">ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</label>
                    <input type="password" id="confirmPassword" required placeholder="Ø£Ø¹Ø¯ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©">
                    <span id="confirmError" class="error"></span>
                </div>
                
                <button type="submit">ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</button>
                <div id="passwordSuccess" class="success"></div>
            </form>
        </div>
    </div>
</div>
    <script>
        let userData = {}
        // ØªØ¹Ø¨Ø¦Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        document.addEventListener('DOMContentLoaded', function() {
                    // Ù‡Ø°Ù‡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙŠÙ…ÙƒÙ† Ø¬Ù„Ø¨Ù‡Ø§ Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù… ÙÙŠ ØªØ·Ø¨ÙŠÙ‚ Ø­Ù‚ÙŠÙ‚ÙŠ
         userData = JSON.parse( localStorage.getItem('userData'))
        


            document.getElementById('fullName').textContent = userData.fullName;
            document.getElementById('email').textContent = userData.email;
            document.getElementById('username').textContent = `Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ ${userData.fullName}`;
            document.getElementById('role').textContent = userData.role;
         if(userData.role === "Doctor"){
             doctorData = JSON.parse( localStorage.getItem('doctorData'))
       
            document.getElementById("specialization-content").style.display = "block";
            document.getElementById("licenseNumber-content").style.display = "block";
            document.getElementById('specialization').textContent = doctorData.specialization;
            document.getElementById('licenseNumber').textContent = doctorData.licenseNumber;

         } else if(userData.role === "Pharmacist"){
            PharmacistData = JSON.parse( localStorage.getItem('PharmacistData'))
       
            document.getElementById("pharmacy-content").style.display = "block";
            document.getElementById("licenseNumber-content").style.display = "block";
            document.getElementById('pharmacy').textContent = PharmacistData.pharmacy.name;
            document.getElementById('licenseNumber').textContent = PharmacistData.licenseNumber;

         }
          
         
         // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø­Ø±Ù Ø§Ù„Ø£ÙˆÙ„Ù‰ ÙƒØ£ÙŠÙ‚ÙˆÙ†Ø© Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù‡Ù†Ø§Ùƒ ØµÙˆØ±Ø©
            const names = userData.fullName.split(' ');
            const initials = names[0].charAt(0) + (names.length > 1 ? names[1].charAt(0) : '');
            document.querySelector('.profile-icon span').textContent = initials;
        });

        
// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ù†Ù…ÙˆØ°Ø¬ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
document.getElementById('passwordForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const currentPassword = document.getElementById('currentPassword').value;
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    
    const currentPasswordError = document.getElementById('currentPasswordError');
    const newPasswordError = document.getElementById('newPasswordError');
    const confirmError = document.getElementById('confirmError');
    const passwordSuccess = document.getElementById('passwordSuccess');
    const submitBtn = document.querySelector('button[type="submit"]');
    
    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø®Ø·Ø£ ÙˆØ§Ù„Ù†Ø¬Ø§Ø­
    currentPasswordError.textContent = '';
    newPasswordError.textContent = '';
    confirmError.textContent = '';
    passwordSuccess.style.display = 'none';
    
    let isValid = true;
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    if (currentPassword.length === 0) {
        currentPasswordError.textContent = 'ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©';
        isValid = false;
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù‚ÙˆØ© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    if (newPassword.length < 6) {
        newPasswordError.textContent = 'ÙŠØ¬Ø¨ Ø£Ù† ØªØ­ØªÙˆÙŠ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¹Ù„Ù‰ 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„';
        isValid = false;
    }/* else if (!/[A-Z]/.test(newPassword) || !/[a-z]/.test(newPassword) || !/[0-9]/.test(newPassword)) {
        newPasswordError.textContent = 'ÙŠØ¬Ø¨ Ø£Ù† ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£Ø­Ø±Ù ÙƒØ¨ÙŠØ±Ø© ÙˆØµØºÙŠØ±Ø© ÙˆØ£Ø±Ù‚Ø§Ù…';
        isValid = false;
    }*/
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ·Ø§Ø¨Ù‚ ÙƒÙ„Ù…ØªÙŠ Ø§Ù„Ù…Ø±ÙˆØ±
    if (newPassword !== confirmPassword) {
        confirmError.textContent = 'ÙƒÙ„Ù…ØªØ§ Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚ØªÙŠÙ†';
        isValid = false;
    }
    
    if (isValid) {
        // ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø²Ø± Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ù…Ù†Ø¹ Ø¥Ø±Ø³Ø§Ù„ Ù…ØªØ¹Ø¯Ø¯
        submitBtn.disabled = true;
        submitBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØºÙŠÙŠØ±...';
        
        // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨
        const requestData = {
            userId: userData.userId,
            currentPassword: currentPassword,
            newPassword: newPassword
        };

      
        
        // Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ API Ù„ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
        fetch('https://localhost:7219/api/Auth/change-password', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + localStorage.getItem('token') // Ø¥Ø°Ø§ ÙƒÙ†Øª ØªØ³ØªØ®Ø¯Ù… Ù†Ø¸Ø§Ù… ØªÙˆØ«ÙŠÙ‚
            },
            body: JSON.stringify(requestData)
        })
        .then(response => {
            if (!response.ok) {
                   // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø®Ø·Ø£ Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…
                if (data.error === 'INCORRECT_PASSWORD') {
                    currentPasswordError.textContent = 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ© ØºÙŠØ± ØµØ­ÙŠØ­Ø©';
                } else if (data.error === 'WEAK_PASSWORD') {
                    newPasswordError.textContent = 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø¶Ø¹ÙŠÙØ© Ø¬Ø¯Ø§Ù‹';
                } else {
                    newPasswordError.textContent = data.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±';
                }
                throw new Error('Network response was not ok');
                
            }

      
                
                // Ø¥Ø®ÙØ§Ø¡ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­ Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù†ÙŠ
                setTimeout(() => {
                    passwordSuccess.style.display = 'none';
                }, 5000);
           
             passwordSuccess.textContent = 'ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­!';
                passwordSuccess.style.display = 'block';
                document.getElementById('passwordForm').reset();
                
                    })
      
        .catch(error => {
            console.error('Error:', error);
            newPasswordError.textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…';
        })
        .finally(() => {
            // Ø¥Ø¹Ø§Ø¯Ø© ØªÙ…ÙƒÙŠÙ† Ø§Ù„Ø²Ø± Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡
            submitBtn.disabled = false;
            submitBtn.textContent = 'ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±';
        });
    }
});
   
        
    </script>
</body>
</html>


