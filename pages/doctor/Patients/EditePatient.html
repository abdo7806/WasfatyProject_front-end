<!DOCTYPE html>
<html lang="ar">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>تعديل بيانات المريض</title>

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
</head>

<body>
    <div class="container">
        <div class="alert alert-danger" id="error-message" style="display: none;" role="alert"></div>

        <h2 class="my-4">تعديل بيانات المريض</h2>
        <form id="editPatientForm">
            <div class="form-group">
                <label for="fullName">الاسم بالكامل:</label>
                <input type="text" id="fullName" class="form-control" />
            </div>

            <div class="form-group">
                <label for="email">البريد الإلكتروني:</label>
                <input type="email" id="email" class="form-control" />
            </div>



            <div class="form-group">
                <label>تاريخ الميلاد:</label>
                <input type="date" id="DateOfBirth" class="form-control" />
            </div>

            <div class="form-group">
                <label for="gender">الجنس:</label>
                <select class="form-control" id="gender">
                    <option value="ذكور">ذكور</option>
                    <option value="إناث">إناث</option>
                </select>
            </div>

            <div class="form-group">
                <label for="bloodType">فصيلة الدم:</label>
                <select class="form-control" id="bloodType">
                    <option value="A+">A+</option>
                    <option value="A-">A-</option>
                    <option value="B+">B+</option>
                    <option value="B-">B-</option>
                    <option value="AB+">AB+</option>
                    <option value="AB-">AB-</option>
                    <option value="O+">O+</option>
                    <option value="O-">O-</option>
                </select>
            </div>

            <button type="button" class="btn btn-primary" onclick="updatePatient()">حفظ التعديلات</button>
            <a href="Patient.html" class="btn btn-secondary">رجوع</a>
        </form>
    </div>

    <script>
        async function loadUserData(patientId) {
            try {
                const response = await fetch(`https://localhost:7219/api/PatientController/${patientId}`);
                if (!response.ok) throw new Error("فشل تحميل البيانات");

                const data = await response.json();
                if (!data.user) throw new Error("بيانات المستخدم غير موجودة");

                document.getElementById("fullName").value = data.user.fullName;
                document.getElementById("email").value = data.user.email;
                document.getElementById("DateOfBirth").value = data.dateOfBirth.split("T")[0];
                document.getElementById("gender").value = data.gender;
                document.getElementById("bloodType").value = data.bloodType;
            } catch (error) {
                showError(error.message);
            }
        }

        async function updateUser(userId, fullName, email, role = 2) {
            const userData = {
                fullName,
                email,
                role: parseInt(role)
            };

            try {
                const response = await fetch(`https://localhost:7219/api/User/${userId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(userData)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'فشل تحديث المستخدم');
                }

                return true;
            } catch (error) {
                showError(error.message);
                return false;
            }
        }

        async function updatePatient() {
            const urlParams = new URLSearchParams(window.location.search);
            const patientId = urlParams.get('id');
            const fullName = document.getElementById('fullName').value;
            const email = document.getElementById('email').value;
            const dateOfBirth = document.getElementById('DateOfBirth').value;
            const gender = document.getElementById('gender').value;
            const bloodType = document.getElementById('bloodType').value;

            try {
                const response = await fetch(`https://localhost:7219/api/PatientController/${patientId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        dateOfBirth,
                        gender,
                        bloodType
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || "فشل تعديل بيانات المريض");
                }

                const updatedPatient = await response.json();
                const userUpdated = await updateUser(updatedPatient.userId, fullName, email, 2);

                if (userUpdated) {
                    alert("تم تعديل البيانات بنجاح");
                    window.location.href = './Patient.html';
                }

            } catch (error) {
                showError(error.message);
            }
        }

        function showError(message) {
            const errorElement = document.getElementById('error-message');
            errorElement.style.display = "block";
            errorElement.textContent = message;
        }

        $(document).ready(function() {
            const urlParams = new URLSearchParams(window.location.search);
            const patientId = urlParams.get('id');

            if (patientId) {
                loadUserData(patientId);
            } else {
                showError('معرف المستخدم غير موجود في عنوان URL.');
            }
        });
    </script>
</body>

</html>