<!DOCTYPE html>
<html lang="ar">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>إضافة مستخدم جديد</title>

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
</head>

<body>
    <div class="container">
        <div class="alert alert-danger" id="error-message" style="display: none;" role="alert"></div>

        <h2 class="my-4">إضافة مستخدم جديد</h2>
        <form id="addUserForm">
            <div class="form-group">
                <label for="fullName">الاسم بالكامل:</label>
                <input type="text" id="fullName" class="form-control" placeholder="الاسم الكامل" />
                <div id="fullNameError" class="text-danger"></div>
            </div>

            <div class="form-group">
                <label for="email">البريد الإلكتروني:</label>
                <input type="email" id="email" class="form-control" placeholder="البريد الإلكتروني" />
                <div id="emailError" class="text-danger"></div>
            </div>

            <div class="form-group">
                <label>كلمة المرور:</label>
                <input type="password" id="password" class="form-control" placeholder="كلمة المرور" />
                <div id="passwordError" class="text-danger"></div>
            </div>

            <div class="form-group">
                <label>تأكيد كلمة المرور:</label>
                <input type="password" id="confirmPassword" class="form-control" placeholder="تأكيد كلمة المرور" />
                <div id="confirmPasswordError" class="text-danger"></div>
            </div>

            <div class="form-group">
                <label>تاريخ الميلاد:</label>
                <input type="date" id="DateOfBirth" class="form-control" />
                <div id="DateOfBirthError" class="text-danger"></div>
            </div>

            <div class="form-group">
                <label for="gender">الجنس:</label>
                <select class="form-control" id="gender" required>
                    <option value="" disabled selected>اختر الجنس</option>
                    <option value="ذكور">ذكور</option>
                    <option value="إناث">إناث</option>
                </select>
            </div>

            <div class="form-group">
                <label for="bloodType">فصيلة الدم:</label>
                <select class="form-control" id="bloodType" required>
                    <option value="" disabled selected>اختر فصيلة الدم</option>
                    <option value="A+">A+</option>
                    <option value="A-">A-</option>
                    <option value="B+">B+</option>
                    <option value="B-">B-</option>
                    <option value="AB+">AB+</option>
                    <option value="AB-">AB-</option>
                    <option value="O+">O+</option>
                    <option value="O-">O-</option>
                </select>
            </div>

            <button type="button" class="btn btn-primary" onclick="addUser()">إنشاء حساب</button>
            <a href="Patient.html" class="btn btn-secondary">رجوع</a>
        </form>
    </div>

    <script>
        function validateForm() {
            const fullName = document.getElementById('fullName').value;
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const dateOfBirth = document.getElementById('DateOfBirth').value;
            const gender = document.getElementById('gender').value;
            const bloodType = document.getElementById('bloodType').value;
            const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

            // إعادة تعيين رسائل الخطأ
            document.getElementById('fullNameError').textContent = '';
            document.getElementById('emailError').textContent = '';
            document.getElementById('passwordError').textContent = '';
            document.getElementById('confirmPasswordError').textContent = '';
            document.getElementById('DateOfBirthError').textContent = '';
            document.getElementById('error-message').style.display = "none";

            let isValid = true;

            if (!fullName) {
                document.getElementById('fullNameError').textContent = 'الاسم الكامل مطلوب!';
                isValid = false;
            }

            if (!email) {
                document.getElementById('emailError').textContent = 'البريد الإلكتروني مطلوب!';
                isValid = false;
            } else if (!emailPattern.test(email)) {
                document.getElementById('emailError').textContent = 'يرجى إدخال بريد إلكتروني صحيح.';
                isValid = false;
            }

            if (!password) {
                document.getElementById('passwordError').textContent = 'كلمة المرور مطلوبة!';
                isValid = false;
            }

            if (password !== confirmPassword) {
                document.getElementById('confirmPasswordError').textContent = 'كلمات المرور غير متطابقة!';
                isValid = false;
            }

            if (!dateOfBirth) {
                document.getElementById('DateOfBirthError').textContent = 'تاريخ الميلاد مطلوب!';
                isValid = false;
            }

            if (!gender) {
                document.getElementById('error-message').style.display = "block";
                document.getElementById('error-message').textContent = 'يرجى اختيار الجنس.';
                isValid = false;
            }

            if (!bloodType) {
                document.getElementById('error-message').style.display = "block";
                document.getElementById('error-message').textContent = 'يرجى اختيار فصيلة الدم.';
                isValid = false;
            }

            return isValid;
        }

        async function addUser() {
            const fullName = document.getElementById('fullName').value;
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const dateOfBirth = document.getElementById('DateOfBirth').value;
            const gender = document.getElementById('gender').value;
            const bloodType = document.getElementById('bloodType').value;
            const role = 3;

            if (!validateForm()) {
                return;
            }

            try {
                const response = await fetch('https://localhost:7219/api/Auth/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        fullName,
                        email,
                        password,
                        role: role
                    })
                });

                if (!response.ok) {
                    throw new Error('فشل التسجيل');
                }

                const createdUser = await response.json();
                await addPatient(createdUser.id, dateOfBirth, gender, bloodType);
                window.location.href = './Patient.html';
            } catch (error) {
                document.getElementById('error-message').style.display = "block";
                document.getElementById('error-message').textContent = error.message;
            }
        }

        async function addPatient(userId, dateOfBirth, gender, bloodType) {
            try {
                const response = await fetch('https://localhost:7219/api/PatientController', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId,
                        dateOfBirth,
                        gender,
                        bloodType
                    })
                });

                if (!response.ok) {
                    throw new Error('فشل إضافة المريض');
                }

                await response.json();
            } catch (error) {
                document.getElementById('error-message').style.display = "block";
                document.getElementById('error-message').textContent = error.message;
            }
        }
    </script>
</body>

</html>