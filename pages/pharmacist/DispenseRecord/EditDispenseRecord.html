<!DOCTYPE html>
<html lang="ar">

<head>
    <meta charset="UTF-8">
    <title>ØªØ¹Ø¯ÙŠÙ„ ØµØ±Ù Ø¯ÙˆØ§Ø¡</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <style>
        body {
            direction: rtl;
            background-color: #f8f9fa;
        }
        
        .select2-container--default .select2-selection--single {
            height: 38px;
        }
        
        .card {
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .medication-item {
            background-color: #ffffff;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
        }
    </style>
</head>

<body class="container mt-5">

    <h2 class="mb-4">ØªØ¹Ø¯ÙŠÙ„ ØµØ±Ù Ø¯ÙˆØ§Ø¡</h2>

    <div id="message" class="mt-3"></div>

    <form id="dispenseForm">
        <input type="hidden" id="dispenseId">
        <!-- Ù„Ø¥Ø®ÙØ§Ø¡ Ù…Ø¹Ø±Ù Ø§Ù„ØµØ±Ù -->

        <div class="mb-3">
            <label for="prescriptionId" class="form-label">Ø±Ù‚Ù… Ø§Ù„ÙˆØµÙØ©</label>
            <input type="number" class="form-control" id="prescriptionId" readonly>
        </div>

        <div class="mb-3">
            <label for="pharmacySelect" class="form-label">Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ©</label>
            <select id="pharmacySelect" class="form-select" required></select>
        </div>

        <div class="mb-3">
            <label for="pharmacistSelect" class="form-label">Ø§Ù„ØµÙŠØ¯Ù„ÙŠ</label>
            <select id="pharmacistSelect" class="form-select" required></select>
        </div>

        <div class="mb-3">
            <label for="dispensedDate" class="form-label">ØªØ§Ø±ÙŠØ® Ø§Ù„ØµØ±Ù</label>
            <input type="date" class="form-control" id="dispensedDate" required>
        </div>

        <button type="submit" class="btn btn-primary">ØªØ­Ø¯ÙŠØ«</button>
        <a href="./DispenseRecords.html" class="btn btn-secondary">Ø±Ø¬ÙˆØ¹</a>
    </form>



    <div class="container mt-5" id="prescriptionInfo">
        <h2 class="mb-4 text-center text-primary">ğŸ’Š ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙˆØµÙØ© Ø§Ù„Ø·Ø¨ÙŠØ©</h2>

        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title text-success">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙˆØµÙØ©</h5>
                <p><strong>Ø±Ù‚Ù… Ø§Ù„ÙˆØµÙØ©:</strong> <span id="prescription-id" class="badge bg-secondary"></span></p>
                <p><strong>Ø§Ù„Ù…Ø±ÙŠØ¶:</strong> <span id="patient-name"></span></p>
                <p><strong>Ø§Ù„Ø·Ø¨ÙŠØ¨:</strong> <span id="doctor-name"></span></p>
                <p><strong>Ù‡Ù„ Ø§Ù„ÙˆØµÙØ© Ù…ØµØ±ÙˆÙØ©:</strong> <span id="isDispensed"></span></p>
                <p><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡:</strong> <span id="created-at"></span></p>
            </div>
        </div>

        <h4 class="mb-3 text-info">ğŸ“ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¯ÙˆÙŠØ©</h4>
        <div id="medication-list" class="mb-3"></div>


    </div>


    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
        $(document).ready(function() {
            const urlParams = new URLSearchParams(window.location.search);
            const dispenseId = urlParams.get('id'); // Ø¬Ù„Ø¨ ID Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·

            if (!dispenseId) {
                $('#message').html('<div class="alert alert-danger">Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø³Ø¬Ù„ Ø§Ù„ØµØ±Ù Ù„Ù„ØªØ¹Ø¯ÙŠÙ„</div>');
                return;
            }

            $('#dispenseId').val(dispenseId);

            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ§Øª
            $.get('https://localhost:7219/api/Pharmacy/All', function(pharmacies) {
                const pharmacyData = pharmacies.map(p => ({
                    id: p.id,
                    text: p.name
                }));
                $('#pharmacySelect').select2({
                    data: pharmacyData,
                    placeholder: 'Ø§Ø®ØªØ± Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ©',
                    allowClear: true
                });
            });

            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙŠØ§Ø¯Ù„Ø©
            $.get('https://localhost:7219/api/Pharmacist/All', function(pharmacists) {
                const pharmacistData = pharmacists.map(p => ({
                    id: p.id,
                    text: p.user ? p.user.fullName : ''
                }));
                $('#pharmacistSelect').select2({
                    data: pharmacistData,
                    placeholder: 'Ø§Ø®ØªØ± Ø§Ù„ØµÙŠØ¯Ù„ÙŠ',
                    allowClear: true
                });
            });

            // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø³Ø¬Ù„ Ø§Ù„ØµØ±Ù Ø§Ù„Ø­Ø§Ù„ÙŠ
            $.get(`https://localhost:7219/api/DispenseRecord/${dispenseId}`, function(dispense) {
                $('#prescriptionId').val(dispense.prescriptionId);
                $('#pharmacySelect').val(dispense.pharmacyId).trigger('change');
                $('#pharmacistSelect').val(dispense.pharmacistId).trigger('change');
                $('#dispensedDate').val(dispense.dispensedDate.split('T')[0]); // Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ®

                $.get(`https://localhost:7219/api/Prescription/${dispense.prescriptionId}`, function(prescription) {
                    if (!prescription) {
                        $('#prescriptionInfo').html('<div class="alert alert-danger">Ø§Ù„ÙˆØµÙØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©</div>');
                        return;
                    }


                    $('#prescription-id').text(`${prescription.id}`);
                    $('#patient-name').text(`${prescription.patient.user.fullName}`);
                    $('#doctor-name').text(`${prescription.doctor.user.fullName}`);
                    $('#isDispensed').text(`${prescription.isDispensed ? 'Ù†Ø¹Ù…' : 'Ù„Ø§'}`);
                    $('#created-at').text(`${new Date(prescription.issuedDate).toLocaleDateString('ar-EG')}`);

                    let html = "";
                    prescription.prescriptionItems.forEach(item => {
                        html += `
												        <div id="medication-item" class="mb-3">
													<h6><span class="badge bg-primary">${item.medicationId}</span></h6>
													<p>ğŸ’Š <strong>Ø¬Ø±Ø¹Ø©:</strong> ${item.dosage}</p>
													<p>â° <strong>Ù…Ø±Ø§Øª ÙŠÙˆÙ…ÙŠØ©:</strong> ${item.frequency}</p>
													<p>ğŸ“… <strong>Ù…Ø¯Ø©:</strong> ${item.duration} ÙŠÙˆÙ…</p>
													</div>
											`;
                    });

                    $('#medication-list').html(html);

                }).fail(function() {
                    $('#prescriptionInfo').html('<div class="alert alert-danger">ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØµÙØ©</div>');
                });



            }).fail(function() {
                $('#message').html('<div class="alert alert-danger">ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø³Ø¬Ù„ Ø§Ù„ØµØ±Ù</div>');
            });





            // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ù„Ù„ØªØ­Ø¯ÙŠØ«
            $('#dispenseForm').on('submit', function(e) {
                e.preventDefault();

                const data = {
                    id: parseInt($('#dispenseId').val()),
                    prescriptionId: parseInt($('#prescriptionId').val()),
                    pharmacyId: parseInt($('#pharmacySelect').val()),
                    pharmacistId: parseInt($('#pharmacistSelect').val()),
                    dispensedDate: $('#dispensedDate').val()
                };

                $.ajax({
                    url: `https://localhost:7219/api/DispenseRecord/${dispenseId}`,
                    method: 'PUT',
                    contentType: 'application/json',
                    data: JSON.stringify(data),
                    success: function() {
                        $('#message').html('<div class="alert alert-success">ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¨Ù†Ø¬Ø§Ø­!</div>');
                    },
                    error: function(xhr) {
                        $('#message').html('<div class="alert alert-danger">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ«: ' + xhr.responseText + '</div>');
                    }
                });
            });
        });
    </script>
</body>

</html>